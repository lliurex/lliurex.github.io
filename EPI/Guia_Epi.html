<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body{
            padding: 10px 40px;
            text-align: justify;
        }
    </style>
</head>
<body><h1 id="epi">EPI</h1>
<p>EPI ( EASY PACKAGE INSTALLER ) es un programa para empaquetar instalaciones mas complicadas que no se pueden realizar mediante debs o para aquellos casos en los cuales la instalacion de un paquete se quiere realizar de una forma sencilla ( mediante el zero-center ).</p>
<p>Un paquete epi puede consistir en dos ficheros:
    - fichero epi
    - script de instalacion.
El fichero .epi si que es necesario, mientras que el script de instalacion solo es necesario en caso de que se quiera hacer algun proceso en alguna de las fases que ejecuta EPI.
Por convención los ficheros se instalaran en la ruta /usr/share/NOMBREDELPAQUETE.</p>
<h2 id="formatodeficheroepi">Formato de fichero epi</h2>
<p>El fichero epi es el fichero que contiene toda la meta informacion sobre el proceso de instalacion, como puede ser la url desde donde se bajara los ficheros necesarios, si necesita de permisos de root. Es un fichero que tiene un mimetype asociado, por lo que al hacer doble click sobre el se lanzara la aplicacion epi-gtk y por lo que tiene una extension .epi .</p>
<h3 id="clavesdelfichero">Claves del fichero</h3>
<ul>
<li><strong>type</strong><ul>
<li>Required : True</li>
<li>Type : String</li>
<li>Values : [ "apt" | "deb" | "file" | "localdeb" ]</li>
<li>Description : Describe el tipo de EPI que es.<ul>
<li>Apt: Realiza una instalacion desde un repositorio mediante apt. Puede ser el propio que ya se dispone u otro que se añade para la ocasion</li>
<li>Deb: Instala un deb que puede estar disponible en el sistema o que puede estar en una url.</li>
<li>File : Ejecuta los pasos que se le indiquen en el fichero de script en el paso de instalación.</li>
<li>localdeb: Es un tipo interno que se usa para poder instalar cualquier deb mediante EPI.</li></ul></li>
<li>Example : <code>{ ... type: "apt" ... }</code></li></ul></li>
<li><strong>script</strong><ul>
<li>Required : False. <em>( Sólo es obligado ofrecer este fichero en el tipo "file", en el resto de tipos es opcional y serviria para ayudar realizando ajustes en las distintas fases de instalación )</em></li>
<li>Description : Indica que para realizar el proceso de instalación/desinstalación se utilizará un script adicional.</li>
<li>Type : Dictionary</li>
<li>Keys : <ul>
<li>name ( STRING ) : Ruta donde se encuentra el script. Esta debe ser una ruta absoluta.</li>
<li>remove ( BOOLEAN ) : Este atributo indicara si el script tiene fase de desinstalación, y sobretodo esta pensado para notificar a la gui que tiene una fase de desisntalación. Este atributo sólo se incluirá si el script dispone de fase de desinstación</li>
<li>getStatus ( BOOLEAN ) : Este atributo indicara si el script tiene una función para informar si la aplicación ya esta instalada (<strong>a utilizar en el caso de file type</strong>). Este atributo sólo se incluirá si el script dispone de la función necesaria para obtener el estado </li>
<li>addRepoKeys ( BOOLEAN ) : Este atributo indicara si el script tiene una función para obtener las keys de los repositorios necesarias para la instalacion en el caso de apt, como alternativa a "key_cmd" (<strong>a utilizar en el caso de apt type</strong>. Este atributo sólo se incluirá si el script dispone de la función para obtener la key </li>
<li>download ( BOOLEAN ) : Este atributo indicara si el script tiene una función para descargar el fichero (o  los ficheros) necesarios para instalar la aplicación (<strong>a utilizar en el caso de file type</strong>. Este atributo sólo se incluirá si el script dispone de la función para descargar ficheros </li></ul></li>
<li>Example: <code>{ ... "script" : { "name" : "/usr/share/foo/foo_script" , "remove" : true, "addRepoKeys":true } } ... }</code></li></ul></li>
<li><strong>depends</strong><ul>
<li>Required: False </li>
<li>Type : String</li>
<li>Description: Este atributo sirve para crear dependencias con otro epi. Sirve para asegurarse que otro epi se ha instalado correctamente antes de instalar nuestro epi. Hay que indicarle la ruta donde se encutra dicho epi. Esto tiene la problematica de que no se puede realizar una dependencia con un nombre unico debido a que no se dispone de un respositorio de epi's.</li>
<li>Example: <code>{ ... "depends":"/usr/share/zero-google-earth/google-earth.epi" ... }</code></li></ul></li>
<li><strong>pkg_list</strong><ul>
<li>Required: true</li>
<li>Description : Lista de paquetes que instalara en la fase de instalación.</li>
<li>Type : List</li>
<li>Keys:<ul>
<li>name ( STRING ) : Nombre del paquete a instalar. Este tambien sera el nombre que se utilice a la hora de mostrar en la gui.</li>
<li>key_store ( STRING ) : "Nombre del paquete en la store para obtener metainformacion. Este atributo sólo se incluirá si existe key para consultar en la store"</li>
<li>eula ( STRING ) : En el caso de que haya que mostrar la licencia del paquete antes de instalar. En este campo se introducirá la dirección desde donde descargar la licencia (http:// o file://).<strong>Ejemplo</strong>: <code>"eula":"https://www.google.com/chrome/privacy/eula_text.html"</code></li>
<li><strong>--- Only on deb | file type ---</strong></li>
<li>version: En caso de ser un deb o file puede tener distintos debs o files para distintas arquitecturas. En este campo se le indica el nombre del deb (o file) que tiene que instalar / descargar dependiendo de la arquitectura. Los valores que puede tomar son <strong>all</strong>, <strong>64b</strong> y <strong>32b</strong>, donde all no distingue entre arquitecturas y los otros dos campos restantes equivalen a lo que indica. Sólo será necesario informar los campos necesarios <strong>Ejemplo</strong> : <code>"version":{"64b":"google-earth-stable_current_amd64.deb","32b":"google-earth-stable_current_i386.deb"}</code></li>
<li>url_download ( STRING ) : Direccion desde donde se ha de descargar el deb. Se puede utilizar el protocolo http o file. Para realizar la descarga solo se indica la ruta base donde estan los debs. En caso de estuviera en carpetas distintas, en este atributo se deberia de poner la ruta comun y completar la ruta en el campo version. Los ficheros descargados se guardaran en la ruta <em>/var/cache/epi-downloads/</em></li></ul></li>
<li>Example: <code>{ ... "pkg_list" : [{"name":"google-earth-pro-stable","version":{"64b":"google-earth-stable_current_amd64.deb","32b":"google-earth-stable_current_i386.deb"},"key_store":"zero-lliurex-gearth","url_download":"http://dl.google.com/dl/earth/client/current/"}] ...}</code></li></ul></li>
<li><strong>repository</strong><ul>
<li><strong>--- Only on apt type ---</strong></li>    
<li>Required: False </li>
<li>Type : List</li>
<li>Description: Lista de de los repositorios que se han de añadir temporalmente para instalar los paquetes indicados en el pkg_list en el tipo de apt. Estos repositorios y claves seran borrados una vez se termine de realizar la instalacion.</li>
<li>Keys:<ul>
<li>url ( STRING ) : Linea exacta que se añadiria en un sources.list del repositorio.</li>
<li>key_cmd ( STRING ) : Comando que se utilizara si es necesario añadir las keys del repositorio para que sea una fuente confiable. Si el comando para añadir las keys es complejo en lugar de utilizar esta key se podria incluir en el script informando para ello la clave "addRepoKeys".</li></ul></li>
<li>Example : <code>{... "repository": [{"url":"deb http://repository.spotify.com stable non-free","key_cmd":"apt-key --keyring /tmp/epi_keyring adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys BBEBDCB318AD50EC6865090613B00F1FD2C19886 0DF731E45CE24F27EEEB1450EFDC8610341D9410"}] ...}</code></li></ul></li>
<li><strong>force32</strong><ul>
<li>Required: False </li>
<li>Type:  Boolean</li>
<li>Description: Fuerza a que en la instalacion se realize en base a 32 bits</li></ul></li>
<li><strong>required_x</strong><ul>
<li>Required: False </li>
<li>Type:  Boolean</li>
<li>Description: Le dice al instalador que para llevar a cabo este proceso es necesario que se ejecute este proceso en una sesion grafica con escritorio. Esto sobretodo se utiliza para aquellos casos en los que las aplicaciones van a lanzar una aplicacion grafica que pide datos o sea necesario aceptar la licencia antes de instalar.</li></ul></li>
<li><strong>selection_enabled</strong><ul>
<li>Required:False</li>
<li>Type: list</li>
<li>Description: Permite indicar si es posible que el usuario seleccione que paquetes de la lista tienen que ser instalados o desinstalados. Ádemás permite indicar si por defecto los paquetes se mostrarán ya seleccionados o bien deseleccionados</li>
<li>Keys:<ul>
<li>active (BOOLEAN) : si toma el valor True se activará la posibilidad de que el usuario pueda seleccionar los paquetes de lista</li>
<li>all_selected (BOOLEAN): permite indicar si los paquetes se mostrarán por defecto ya marcados o bien desmarcados</li></ul>
<li>Example : <code>{..."selection_enabled":{"active":True,"all_selected":False}}</code></li></ul></li>
<li><strong>zomando</strong><ul>
<li>Required: False </li>
<li>Type: String</li>
<li>Description: Aqui se indica el zomando asociado (puede no tenerlo) para realizar las modificaciones del estado correspondiente a este. De esta forma si se instala un paquete en el zero-center se representara como instalado.</li></ul></li>
<li><strong>require_dconf</strong><ul>
<li><strong>--- Only on apt or deb type ---</strong></li>    
<li>Required: False</li>
<li>Type: Boolean</li>
<li>Description: Este campo esta pensado para indicarle al instalador que se permite durante la instalación del paquete mostrar al usuario preguntas relacionadas con la configuración del mismo mediante la interfaz de Debconf.</li></ul></li>
<li><strong>require_root</strong><ul>
<li><strong>--- Only on file type ---</strong></li>    
<li>Required: False</li>
<li>Type: Boolean</li>
<li>Description: Este campo esta pensado para indicarle al instalador que se require de permisos de root para poder instalar esta aplicacion. Esta enfocado para aquellas aplicaciones que pueden ser instalados en el home del usuario. De esta forma si la aplicacion se instala en su home el valor de este atributo sera false.</li></ul></li>

</ul>
<h2 id="formatodelficheroEPI">Formato del fichero EPI</h2>
<p>Se muestra a continuación unos ejemplos completos de ficheros EPI </p>
<pre><code>
 {
    "type":"file",
    "pkg_list": [{"name":"telegram","key_store":"zero-lliurex-telegram"}], 
    "script": {"name":"/usr/share/zero-lliurex-telegram/telegram_script","remove":true,"getStatus":true,"download":true},
    "required_x":true,
    "required_root":true,
    "zomado":"zero-lliurex-telegram"
    
    }
</code></pre> 
<pre><code>
{
	"type":"apt",
	"pkg_list": [{"name":"google-chrome-stable","key_store":"zero-lliurex-chrome","eula":"https://www.google.com/chrome/privacy/eula_text.html"}], 
	"repository": [{"url":"deb http://dl.google.com/linux/chrome/deb/ stable main","key_cmd":"wget -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key --keyring /tmp/epi_keyring add -"}], 
	"script": {"name":"/usr/share/zero-lliurex-chrome/chrome_script", "remove":true},
	"zomando":"zero-lliurex-chrome",
	"required_x":true	
	
	}
</code></pre>
<pre><code>
{
	"type":"apt",
	"pkg_list": [{"name":"rsc-alquimia"},{"name":"rsc-animals-vertebrats"},{"name":"rsc-caixademusica"},{"name":"rsc-cifras"},{"name":"rsc-ingles"},{"name":"rsc-jclics"},{"name":"rsc-matematicas3"},{"name":"rsc-primartis"},{"name":"rsc-ser-pensar-conviure-fer"},{"name":"rsc-simon"}], 
	"repository": [{"url":"deb http://ppa.launchpad.net/llxdev/recursos/ubuntu xenial main"}], 
	"script": {"name":"/usr/share/zero-lliurex-recursos/primary_script", "remove":true},
	"selection_enabled":{"active":true,"all_selected":true},
	"zomando":"zero-lliurex-recursos-pri"
	
	}
</code></pre>	   
<h3 id="example">Example</h3>
<h2 id="formatodelscriptdeinstalacion">Formato del script de instalacion</h2>
<p>El script de instalacion es el encargado de indicar todas las acciones que se ejecutaran en las distintas fases que ejecuta EPI. Estas fases son las siguientes:
    - preinstall
    - installPackage
    - postinstall
    - remove
    - getStatus
    - addRepoKeys
    - download
</p>
<p>En cada una de las fases se llama el script entero pasandole como argumento la fase en la que se encuentra. Por esta razon se ha de hacer una comparacion del argumento que estamos recibiendo para ejecutar los pasos de instalacion o para realizar el paso de desinstalacion. Es <strong>importante</strong> que el script termine con exit 0 y en caso de que exista un error se salga del scritp con exit 1</p>
<h3 id="example">Example</h3>
<pre><code>#!/bin/bash

ACTION="$1"
PKG="$2"

USERHOME=$(getent passwd $USER | cut -f6 -d ':')
BINDIR=$USERHOME"/.local/bin"
DESTDIR=$BINDIR"/telegram"
DESTDOWNLOAD="/var/cache/epi-downloads"
DESTDESKTOP=$USERHOME"/.local/share/applications/zero-lliurex-telegram.desktop"


TCH_URL="https://desktop.telegram.org/changelog"
TVERSION=$(wget -qO- $TCH_URL | sed -e 's/<[^>]*>//g;/^\s*$/d' | grep -o 'v [0-9.]*' -m1 | cut -d ' ' -f2)

if [[ $(arch) == "x86_64" ]]
then
    TSETUP="tsetup.${TVERSION}.tar.xz"
    TURL="https://updates.tdesktop.com/tlinux/"
else
    TSETUP="tsetup32.${TVERSION}.tar.xz"
    TURL="https://updates.tdesktop.com/tlinux32/"
fi


case $ACTION in

    getStatus)
        case $PKG in
            telegram)
                if [ -d ${DESTDIR} ]; then
                    echo 0
                else
                    echo 1
                fi
            ;;
        esac                        
    ;;

    download)
        
        cd ${DESTDOWNLOAD}

        if [ -s ${DESTDOWNLOAD}"/"${TSETUP} ]
        then
            rm -f ${DESTDOWNLOAD}"/"${TSETUP}
        fi

        wget ${TURL}${TSETUP}
        
        if ! [ -s ${DESTDOWNLOAD}"/"${TSETUP} ]
        then    
            exit 1
        fi  
    ;;  
    
    installPackage)

        if ! [ -d $DESTDIR ]
        then
            echo $DESTDIR
            mkdir $DESTDIR
        fi  

        echo "Unzipping file..."
        
        FIRSTPWD=$PWD
        cd $DESTDOWNLOAD
        tar -Jxf $TSETUP -C $DESTDIR
        USER_GR=$(id -g -n ${USER})
        chown -R ${USER}:${USER_GR} $BINDIR
        
        if [ $? -eq 0 ]
        then    
            cd $FIRSTPWD
            echo "Launching telegram..."
            su $USER -c /usr/bin/telegram &
        else
            rm -r $DESTDIR
            exit 1
        fi
        
    ;;

    remove)
        
        echo "Removing files..."
        if [ -d $DESTDIR ]
        then
            rm -rf $DESTDIR
        fi  

        if [ -f $DESTDESKTOP ]
        then
            rm -f $DESTDESKTOP
        fi   
    ;;      
        
esac
exit 0
</code></pre>
<h3 id="example">Example</h3>
<p>Se muestra un ejemplo de script que permite desinstalar los paquetes que haya seleccionado el usuario. Las lista de paquetes seleccionados se recibe como un parámetro</p>
<pre><code>#!/bin/bash
ACTION="$1"
shift
PACKAGE_LIST=$@

case $ACTION in
	remove)
		for ix in $PACKAGE_LIST	
		do

			apt-get remove -y $ix
			TEST=$( dpkg-query -s  $ix 2> /dev/null| grep Status | cut -d " " -f 4 )
			if [ "$TEST" == 'installed' ];then
				exit 1
			fi
							
		done		
	;;	
esac
exit 0
</code></pre>
</body>
</html>
